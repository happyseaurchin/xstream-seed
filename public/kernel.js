// HERMITCRAB 0.1 — Bootstrap loader
// Fetches constitution, calls LLM, compiles response as React, renders it.
// Everything else is generated by the instance.

(async function boot() {
  const root = document.getElementById('root');
  const saved = localStorage.getItem('xstream_api_key');

  // Phase 1: Get API key
  if (!saved) {
    root.innerHTML = `
      <div style="max-width:500px;margin:80px auto;font-family:monospace;color:#ccc">
        <h2 style="color:#67e8f9">◇ HERMITCRAB 0.1</h2>
        <p style="color:#666;font-size:13px">XSTREAM SEED — the instance builds its own shell</p>
        <p style="margin:20px 0;font-size:14px">
          Provide your Claude API key. It stays in your browser, proxied only to Anthropic.
        </p>
        <input id="key" type="password" placeholder="sk-ant-api03-..."
          style="width:100%;padding:8px;background:#1a1a2e;border:1px solid #333;color:#ccc;font-family:monospace;border-radius:4px" />
        <button id="go" style="margin-top:12px;padding:8px 20px;background:#164e63;color:#ccc;border:none;border-radius:4px;cursor:pointer;font-family:monospace">
          Wake kernel
        </button>
      </div>`;
    document.getElementById('go').onclick = () => {
      const k = document.getElementById('key').value.trim();
      if (!k.startsWith('sk-ant-')) return alert('Key must start with sk-ant-');
      localStorage.setItem('xstream_api_key', k);
      boot();
    };
    return;
  }

  // Phase 2: Fetch constitution
  root.innerHTML = '<p style="color:#666;font-family:monospace;padding:40px">◇ loading constitution...</p>';
  let constitution;
  try {
    const res = await fetch('/kernels/active.md');
    constitution = await res.text();
  } catch (e) {
    root.innerHTML = `<p style="color:red;font-family:monospace;padding:40px">Constitution load failed: ${e.message}</p>`;
    return;
  }

  // Phase 3: Ask instance to build its shell
  root.innerHTML = '<p style="color:#67e8f9;font-family:monospace;padding:40px">◇ instance waking... building shell...</p>';

  try {
    const response = await fetch('/api/claude', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-API-Key': saved },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 16000,
        system: constitution,
        messages: [{ role: 'user', content: 'BOOT' }],
      })
    });

    if (!response.ok) {
      const err = await response.text();
      root.innerHTML = `<p style="color:red;font-family:monospace;padding:40px">API error (${response.status}): ${err}</p>`;
      return;
    }

    const data = await response.json();
    const code = data.content?.[0]?.text || '';

    // Phase 4: Extract and compile React code
    const match = code.match(/```(?:jsx?|react)?\s*\n([\s\S]*?)```/);
    const jsx = match ? match[1] : code;

    const compiled = Babel.transform(jsx, {
      presets: ['react'],
      plugins: []
    }).code;

    // Phase 5: Render with capabilities
    const callLLM = async (messages, system) => {
      const res = await fetch('/api/claude', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-API-Key': saved },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 4096,
          system: system || constitution,
          messages
        })
      });
      const d = await res.json();
      return d.content?.[0]?.text || 'No response.';
    };

    const capabilities = { callLLM, constitution, localStorage, React, ReactDOM };
    const module = { exports: {} };
    const fn = new Function('React', 'ReactDOM', 'capabilities', 'module', 'exports', compiled);
    fn(React, ReactDOM, capabilities, module, module.exports);

    const Component = module.exports.default || module.exports;
    if (typeof Component === 'function') {
      ReactDOM.createRoot(root).render(React.createElement(Component, capabilities));
    } else {
      root.innerHTML = `<div style="font-family:monospace;color:#ccc;padding:40px;white-space:pre-wrap">${code}</div>`;
    }
  } catch (e) {
    root.innerHTML = `<pre style="color:red;font-family:monospace;padding:40px">Shell build failed:\n${e.message}\n\n${e.stack}</pre>`;
  }
})();
